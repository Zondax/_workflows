name: List Docker Images (Reusable)

on:
  workflow_call:
    inputs:
      service:
        description: 'Service to list images for'
        required: true
        type: string
      environment:
        description: 'Environment context (affects which registry to check)'
        required: true
        type: string
      limit:
        description: 'Number of recent images to show per service'
        required: false
        type: string
        default: '10'

jobs:
  list-images:
    name: List Docker Images
    runs-on: zondax-runners
    environment: ${{ inputs.environment == 'both' && 'dev' || inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Authenticate with GCP
        uses: zondax/actions/gcp-wif-auth@v1
        with:
          workload_identity_provider: ${{ vars.PULUMI_DEPLOY_WIF_PROVIDER }}
          project_id: ${{ vars.PULUMI_GCP_PROJECT_ID }}

      - name: List API Images
        if: inputs.service == 'api' || inputs.service == 'all'
        run: |
          echo "================================================"
          echo "ğŸ”¸ API SERVICE DOCKER IMAGES"
          echo "Registry: ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}"
          echo "================================================"
          
          echo "ğŸ“‹ Recent API images (limit: ${{ inputs.limit }}):"
          if gcloud artifacts docker tags list \
            ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/api \
            --sort-by="~CREATE_TIME" \
            --limit="${{ inputs.limit }}" \
            --format='table(
              TAG:label="ğŸ·ï¸  TAG",
              IMAGE:label="ğŸ³ IMAGE",
              CREATE_TIME.date():label="ğŸ“… CREATED"
            )' 2>/dev/null; then
            
            echo ""
            echo "ğŸ“ COMMIT INFORMATION:"
            # Extract commit info from tags  
            gcloud artifacts docker tags list \
              ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/api \
              --sort-by="~CREATE_TIME" \
              --limit="${{ inputs.limit }}" \
              --format='value(TAG)' 2>/dev/null | while read -r tag; do
              if [ -n "$tag" ]; then
                # GitHub SHA is 40 characters long (full SHA from build workflow)
                if echo "$tag" | grep -q '^[a-f0-9]\{40\}$'; then
                  SHORT_SHA=$(echo "$tag" | cut -c1-8)
                  echo "   ğŸ”— $tag (ğŸ“ commit: $SHORT_SHA)"
                elif echo "$tag" | grep -q '^sha-'; then
                  COMMIT_SHA=$(echo "$tag" | sed 's/^sha-//')
                  echo "   ğŸ”— $tag (ğŸ“ commit: $COMMIT_SHA)"
                else
                  echo "   ğŸ”— $tag"
                fi
              fi
            done
            
            echo ""
            echo "ğŸ’¡ USAGE EXAMPLES:"
            echo "   ğŸš€ Deploy Canary: Use the commit SHA tag from above"
            echo "   Example: Copy the full SHA after ğŸ”— (e.g., abc123def456...)"
          else
            echo "âš ï¸  No API images found or repository doesn't exist yet"
            echo "ğŸ’¡ Images will appear here after the first successful build"
          fi
          echo ""

      - name: List Store Images
        if: inputs.service == 'store' || inputs.service == 'all'
        run: |
          echo "================================================"
          echo "ğŸ”¸ STORE SERVICE DOCKER IMAGES"
          echo "Registry: ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}"
          echo "================================================"
          
          echo "ğŸ“‹ Recent Store images (limit: ${{ inputs.limit }}):"
          if gcloud artifacts docker tags list \
            ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/store \
            --sort-by="~CREATE_TIME" \
            --limit="${{ inputs.limit }}" \
            --format='table(
              TAG:label="ğŸ·ï¸  TAG",
              IMAGE:label="ğŸ³ IMAGE",
              CREATE_TIME.date():label="ğŸ“… CREATED"
            )' 2>/dev/null; then
            
            echo ""
            echo "ğŸ“ COMMIT INFORMATION:"
            # Extract commit info from tags  
            gcloud artifacts docker tags list \
              ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/store \
              --sort-by="~CREATE_TIME" \
              --limit="${{ inputs.limit }}" \
              --format='value(TAG)' 2>/dev/null | while read -r tag; do
              if [ -n "$tag" ]; then
                # GitHub SHA is 40 characters long (full SHA from build workflow)
                if echo "$tag" | grep -q '^[a-f0-9]\{40\}$'; then
                  SHORT_SHA=$(echo "$tag" | cut -c1-8)
                  echo "   ğŸ”— $tag (ğŸ“ commit: $SHORT_SHA)"
                elif echo "$tag" | grep -q '^sha-'; then
                  COMMIT_SHA=$(echo "$tag" | sed 's/^sha-//')
                  echo "   ğŸ”— $tag (ğŸ“ commit: $COMMIT_SHA)"
                else
                  echo "   ğŸ”— $tag"
                fi
              fi
            done
            
            echo ""
            echo "ğŸ’¡ USAGE EXAMPLES:"
            echo "   ğŸš€ Deploy Canary: Use the commit SHA tag from above"
            echo "   Example: Copy the full SHA after ğŸ”— (e.g., xyz789abc123...)"
          else
            echo "âš ï¸  No Store images found or repository doesn't exist yet"
            echo "ğŸ’¡ Images will appear here after the first successful build"
          fi
          echo ""

      - name: List API Relay Images
        if: inputs.service == 'api-relay' || inputs.service == 'all'
        run: |
          echo "================================================"
          echo "ğŸ”¸ API-RELAY SERVICE DOCKER IMAGES"
          echo "Registry: ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}"
          echo "================================================"
          
          echo "ğŸ“‹ Recent API-Relay images (limit: ${{ inputs.limit }}):"
          if gcloud artifacts docker tags list \
            ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/api-relay \
            --sort-by="~CREATE_TIME" \
            --limit="${{ inputs.limit }}" \
            --format='table(
              TAG:label="ğŸ·ï¸  TAG",
              IMAGE:label="ğŸ³ IMAGE",
              CREATE_TIME.date():label="ğŸ“… CREATED"
            )' 2>/dev/null; then
            
            echo ""
            echo "ğŸ“ COMMIT INFORMATION:"
            # Extract commit info from tags  
            gcloud artifacts docker tags list \
              ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/api-relay \
              --sort-by="~CREATE_TIME" \
              --limit="${{ inputs.limit }}" \
              --format='value(TAG)' 2>/dev/null | while read -r tag; do
              if [ -n "$tag" ]; then
                # GitHub SHA is 40 characters long (full SHA from build workflow)
                if echo "$tag" | grep -q '^[a-f0-9]\{40\}$'; then
                  SHORT_SHA=$(echo "$tag" | cut -c1-8)
                  echo "   ğŸ”— $tag (ğŸ“ commit: $SHORT_SHA)"
                elif echo "$tag" | grep -q '^sha-'; then
                  COMMIT_SHA=$(echo "$tag" | sed 's/^sha-//')
                  echo "   ğŸ”— $tag (ğŸ“ commit: $COMMIT_SHA)"
                else
                  echo "   ğŸ”— $tag"
                fi
              fi
            done
            
            echo ""
            echo "ğŸ’¡ USAGE EXAMPLES:"
            echo "   ğŸš€ Deploy Canary: Use the commit SHA tag from above"
            echo "   Example: Copy the full SHA after ğŸ”— (e.g., def456abc789...)"
          else
            echo "âš ï¸  No API-Relay images found or repository doesn't exist yet"
            echo "ğŸ’¡ Images will appear here after the first successful build"
          fi
          echo ""

      - name: Show Recent Builds Summary
        run: |
          echo "================================================"
          echo "ğŸ“Š RECENT BUILDS SUMMARY"
          echo "================================================"
          
          echo "ğŸ” Finding most recent images across all services..."
          
          # Get most recent image for each service
          echo ""
          echo "ğŸ•’ LATEST IMAGES BY SERVICE:"
          
          for service in api store api-relay; do
            echo "ğŸ”¸ $service:"
            LATEST_IMAGE=$(gcloud artifacts docker images list \
              ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/$service \
              --sort-by="~CREATE_TIME" \
              --limit="1" \
              --format='value(IMAGE)' 2>/dev/null || echo "")
            
            if [ -n "$LATEST_IMAGE" ]; then
              # Extract the full tag and commit SHA
              IMAGE_TAG=$(echo "$LATEST_IMAGE" | sed 's/.*://')
              COMMIT_SHA=$(echo "$IMAGE_TAG" | sed 's/^sha-//')
              CREATED=$(gcloud artifacts docker images list \
                ${{ vars.PULUMI_GAR_LOCATION }}-docker.pkg.dev/${{ vars.PULUMI_GCP_PROJECT_ID }}/${{ vars.PULUMI_GAR_REPOSITORY }}/$service \
                --sort-by="~CREATE_TIME" \
                --limit="1" \
                --format='value(CREATE_TIME.date())' 2>/dev/null || echo "Unknown")
              
              echo "   ğŸ·ï¸  Tag: $IMAGE_TAG"
              if [ ${#COMMIT_SHA} -eq 40 ] || [ ${#COMMIT_SHA} -eq 7 ]; then
                echo "   ğŸ”— Commit: $COMMIT_SHA"
              fi
              echo "   ğŸ“… Created: $CREATED"
            else
              echo "   âš ï¸  No images found"
            fi
            echo ""
          done

      - name: Generate Usage Instructions
        run: |
          echo "================================================"
          echo "ğŸ¯ CANARY DEPLOYMENT USAGE"
          echo "================================================"
          echo ""
          echo "ğŸ“ HOW TO USE THESE IMAGES:"
          echo ""
          echo "1ï¸âƒ£  COPY THE IMAGE TAG:"
          echo "   - Use the SHA tag (e.g., sha-abc123)"
          echo "   - Or use the full image URL"
          echo ""
          echo "2ï¸âƒ£  DEPLOY CANARY:"
          echo "   - Go to Actions â†’ ğŸš€ Deploy Canary"
          echo "   - Paste the image tag in 'Image Tag' field"
          echo "   - Select service and environment"
          echo "   - Start with 10% traffic"
          echo ""
          echo "3ï¸âƒ£  PROMOTE GRADUALLY:"
          echo "   - Monitor for 10-30 minutes"
          echo "   - Use â¬†ï¸ Promote Canary: 10% â†’ 25% â†’ 50% â†’ 75%"
          echo "   - Use âœ… Finalize Canary for 100%"
          echo ""
          echo "ğŸš¨ EMERGENCY ROLLBACK:"
          echo "   - Use ğŸš¨ Rollback Canary if issues detected"
          echo "   - Returns to stable version in ~30 seconds"
          echo ""
          echo "ğŸ’¡ TIP: Use 'List Cloud Run Services' to see current deployments"
          echo ""
          echo "ğŸ”— RELATED WORKFLOWS:"
          echo "   - ğŸ“‹ List Cloud Run Services (see current state)"
          echo "   - ğŸš€ Deploy Canary (start deployment)"
          echo "   - â¬†ï¸ Promote Canary (increase traffic)"
          echo "   - âœ… Finalize Canary (complete deployment)"
          echo "   - ğŸš¨ Rollback Canary (emergency recovery)"