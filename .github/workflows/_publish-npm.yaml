name: Reusable Publish NPM

# Uses OIDC Trusted Publishing - no tokens needed
# Configure trusted publisher on npmjs.com for your package
# See: https://docs.npmjs.com/trusted-publishers/

on:
  workflow_call:
    inputs:
      timeout_minutes:
        description: "Timeout in minutes for the job"
        type: number
        default: 10
      dry_run:
        description: "If true, will not publish to npm"
        type: boolean
        default: false
      github_app_auth:
        description: "Use GitHub App Token"
        required: false
        type: boolean
        default: false
      github_app_repos:
        description: "Additional repositories to access (one per line)"
        required: false
        type: string
        default: ""
      node_version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "22"
      npm_scope:
        description: "npm scope for registry auth (e.g. @zondax, @kunobi)"
        required: false
        type: string
        default: "@zondax"

    secrets:
      app_id:
        description: "GitHub App ID"
        required: false
      app_pem:
        description: "GitHub App PEM"
        required: false

jobs:
  publish:
    timeout-minutes: ${{ inputs.timeout_minutes }}
    runs-on: ubuntu-latest # GitHub-hosted runners required for OIDC trusted publishing
    permissions:
      contents: read
      id-token: write # Required for OIDC trusted publishing

    steps:
      - name: Checkout with GitHub App
        uses: zondax/actions/checkout-with-app@v1
        with:
          github_app_auth: ${{ inputs.github_app_auth }}
          github_app_repos: ${{ inputs.github_app_repos }}
          fetch_depth: 0
          checkout_submodules: true
          app_id: ${{ secrets.app_id }}
          app_pem: ${{ secrets.app_pem }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: false
          cache_save: false

      - name: Run ci_postinstall
        run: |
          if mise tasks --no-header 2>/dev/null | grep -q "^ci_postinstall"; then
            mise run ci_postinstall
          fi

      - name: Detect package manager
        id: pm
        run: |
          if mise tasks --no-header 2>/dev/null | grep -q "^ci_detect_pm"; then
            echo "$(mise run ci_detect_pm)" >> $GITHUB_OUTPUT
          else
            # Default detection
            if [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then
              echo "pm=bun" >> $GITHUB_OUTPUT
            elif [ -f "pnpm-lock.yaml" ]; then
              echo "pm=pnpm run" >> $GITHUB_OUTPUT
            elif [ -f "yarn.lock" ]; then
              echo "pm=yarn run" >> $GITHUB_OUTPUT
            elif [ -f "package-lock.json" ]; then
              echo "pm=npm run" >> $GITHUB_OUTPUT
            else
              echo "Error: Could not detect package manager. No lock file found (bun.lockb, bun.lock, pnpm-lock.yaml, yarn.lock, or package-lock.json)."
              echo "Either add a lock file or define a 'ci_detect_pm' mise task to specify the package manager."
              exit 1
            fi
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          registry-url: "https://registry.npmjs.org"
          scope: ${{ inputs.npm_scope }}

      - name: Upgrade npm for OIDC support
        run: |
          echo "Current npm version: $(npm --version)"
          npm install -g npm@latest
          echo "Updated npm version: $(npm --version)"

      - name: Build package
        run: if grep -q '"build"' package.json; then ${{ steps.pm.outputs.pm }} build; else echo "No build script found, skipping"; fi

      - name: Set version from Git
        run: |
          if git describe --tags --abbrev=0 --match='*.*.*' 2>/dev/null; then
            npm version from-git --no-git-tag-version --allow-same-version
          elif [ "$DRY_RUN" = "true" ]; then
            echo "No semver tags found, keeping version from package.json (dry-run)"
          else
            echo "::error::No semver tags found. Cannot publish without a version tag."
            exit 1
          fi
        env:
          DRY_RUN: ${{ inputs.dry_run }}

      - name: Log package version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Package version: $VERSION"
          echo "::notice title=NPM Package Version::$VERSION"

      - name: Copy README.npm.md to README.md if exists
        run: |
          if [ -f README.npm.md ]; then
            cp README.npm.md README.md
            echo "Copied README.npm.md to README.md"
          fi

      - name: Debug OIDC environment
        run: |
          echo "=== npm version ==="
          npm --version
          echo ""
          echo "=== Node version ==="
          node --version
          echo ""
          echo "=== OIDC Token Info ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL != '' }}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN != '' }}"
          echo ""
          echo "=== GitHub Context ==="
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Workflow ref: ${{ github.workflow_ref }}"
          echo "Job workflow ref: ${{ github.job_workflow_sha }}"
          echo "Run ID: ${{ github.run_id }}"

      - name: Publish package
        if: ${{ !inputs.dry_run }}
        run: |
          # Provenance only supported for public repos
          PROVENANCE_FLAG=""
          if [[ "$REPO_VISIBILITY" == "public" ]]; then
            PROVENANCE_FLAG="--provenance"
          else
            echo "Skipping provenance (private repo)"
          fi

          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "Prerelease detected via GitHub release flag"
            npm publish $PROVENANCE_FLAG --access public --tag prerelease --verbose
          else
            echo "Stable release"
            npm publish $PROVENANCE_FLAG --access public --verbose
          fi
        env:
          IS_PRERELEASE: ${{ github.event.release.prerelease }}
          REPO_VISIBILITY: ${{ github.event.repository.visibility }}

      - name: Dry-run publish
        if: ${{ inputs.dry_run }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Dry-run validating package at version: $VERSION"
          npm pack --dry-run
