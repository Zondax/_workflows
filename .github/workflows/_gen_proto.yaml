name: Reusable Proto Generation Check

on:
  workflow_call:
    inputs:
      runner:
        description: "GitHub runner to use"
        type: string
        default: "zondax-runners"
      container_image:
        description: "Container image to use"
        type: string
        default: "ubuntu:24.04"
      github_app_auth:
        description: "Use GitHub App Token"
        required: false
        type: boolean
        default: false
      github_app_repos:
        description: "Additional repositories to access (one per line)"
        required: false
        type: string
        default: ""
      timeout_minutes:
        description: "Timeout in minutes for the job"
        type: number
        default: 10

jobs:
  checks-proto:
    runs-on: ${{ inputs.runner }}
    container:
      image: ${{ inputs.container_image }}
    timeout-minutes: ${{ inputs.timeout_minutes }}

    steps:
      - name: Setup Ubuntu packages
        uses: zondax/actions/setup-ubuntu-packages@v1
        with:
          packages: |
            - bash
            - protobuf-compiler
            - libprotobuf-dev

      - name: Checkout with GitHub App
        uses: zondax/actions/checkout-with-app@v1
        with:
          github_app_auth: ${{ inputs.github_app_auth }}
          github_app_repos: ${{ inputs.github_app_repos }}
          app_id: ${{ secrets.app_id }}
          app_pem: ${{ secrets.app_pem }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: false

      - name: Run ci_postinstall
        run: |
          if mise tasks --no-header 2>/dev/null | grep -q "^ci_postinstall"; then
            mise run ci_postinstall
          fi

      - name: Detect package manager
        id: pm
        run: |
          if mise tasks --no-header 2>/dev/null | grep -q "^ci_detect_pm"; then
            echo "$(mise run ci_detect_pm)" >> $GITHUB_OUTPUT
          else
            # Default detection
            if [ -f "bun.lockb" ] || [ -f "bun.lock" ]; then
              echo "pm=bun" >> $GITHUB_OUTPUT
            elif [ -f "pnpm-lock.yaml" ]; then
              echo "pm=pnpm run" >> $GITHUB_OUTPUT
            elif [ -f "yarn.lock" ]; then
              echo "pm=yarn run" >> $GITHUB_OUTPUT
            elif [ -f "package-lock.json" ]; then
              echo "pm=npm run" >> $GITHUB_OUTPUT
            else
              echo "Error: Could not detect package manager. No lock file found (bun.lockb, bun.lock, pnpm-lock.yaml, yarn.lock, or package-lock.json)."
              echo "Either add a lock file or define a 'ci_detect_pm' mise task to specify the package manager."
              exit 1
            fi
          fi

      - name: Install proto generation tools
        run: |
          npm install -g protoc-gen-js protoc-gen-grpc-web grpc-tools grpc_tools_node_protoc_ts
          # Verify installations
          which protoc-gen-js || echo "protoc-gen-js not found in PATH"
          which protoc-gen-grpc-web || echo "protoc-gen-grpc-web not found in PATH"
          which grpc_tools_node_protoc_plugin || echo "grpc_tools_node_protoc_plugin not found in PATH"
          which grpc_tools_node_protoc_ts || echo "grpc_tools_node_protoc_ts not found in PATH"
          # Create symlink for protoc-gen-ts (expected by gen-proto-grpc-js.sh)
          ln -sf $(which grpc_tools_node_protoc_ts) /usr/local/bin/protoc-gen-ts || true

      - name: Generate ts from proto
        run: ${{ steps.pm.outputs.pm }} gen:proto

      - name: Check for pending changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo -e "\033[0;31m❌ ERROR\033[0m: There are uncommitted changes after proto generation."
            echo "This likely means the proto files were modified but the generated code wasn't updated."
            echo "Please run 'bun gen:proto' locally and commit the changes."
            git status
            exit 1
          else
            echo -e "\033[0;32m✅\033[0m No pending changes detected after proto generation."
          fi