name: Playwright Tests
on:
  workflow_call:
    inputs:
      working_directory:
        description: "Working directory for tests"
        type: string
        default: "."
      build_command:
        description: "Build command to run before tests"
        type: string
        default: "pnpm run build"
      test_command:
        description: "Command to run Playwright tests"
        type: string
        default: "pnpm run test:e2e:sharding"
      install_command:
        description: "Command to install Playwright browsers"
        type: string
        default: "pnpm test:e2e:install"
      runner:
        description: "GitHub runner to use"
        type: string
        default: "zondax-runners"
      node_version:
        description: "Node.js container version"
        type: string
        default: "node:20-bookworm"
      use_env_script:
        description: "Whether to use the environment script provided in secrets"
        type: boolean
        required: false
        default: true
    secrets:
      env_script:
        description: "Bash script to set environment variables (one export per line)"
        required: false
  
env:
  HEAD_SHA: ${{ github.event.pull_request.head.sha }}
  HEAD_BRANCH_NAME: ${{ github.head_ref }}

jobs:
  playwright:
    name: Playwright Shard
    runs-on: ${{ inputs.runner }}
    strategy:
      matrix:
        include:
          - position: shard1
            playwrightShard: "1/2"
          - position: shard2
            playwrightShard: "2/2"
    container:
      image: ${{ inputs.node_version }}
      env:
        PLAYWRIGHT_SHARD: ${{ matrix.playwrightShard }}
        CI: true
        HEAD_SHA: ${{ env.HEAD_SHA }}
        HEAD_BRANCH_NAME: ${{ env.HEAD_BRANCH_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Disable shallow clone

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            libnss3 \
            libnspr4 \
            libdbus-1-3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libxkbcommon0 \
            libasound2

      - name: Setup environment variables
        if: inputs.use_env_script
        run: |
          # Create environment script
          cat > /tmp/env.sh << 'EOL'
          #!/bin/bash
          # Environment setup script
          
          ${{ secrets.env_script }}
          EOL
          
          # Make it executable
          chmod +x /tmp/env.sh
          
          # Source it to set variables in this shell
          source /tmp/env.sh
          
          # Export to GITHUB_ENV for future steps
          env | while read -r line; do
            echo "$line" >> $GITHUB_ENV
          done
          
          # List environment variables (only names for security)
          echo "Environment variables set:"
          env | cut -d= -f1 | sort

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Run build
        working-directory: ${{ inputs.working_directory }}
        run: ${{ inputs.build_command }}

      - name: Install Playwright browsers
        working-directory: ${{ inputs.working_directory }}
        run: ${{ inputs.install_command }}

      - name: Run Playwright tests
        working-directory: ${{ inputs.working_directory }}
        run: ${{ inputs.test_command }}

      - name: Upload Playwright Report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.position }}
          path: ${{ inputs.working_directory }}/playwright-report/
          retention-days: 15
